https://wokwi.com/projects/448661233234617345




#include <stdio.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/gpio.h"
#include "driver/ledc.h"
#include "esp_err.h"

#define LEDC_TIMER          LEDC_TIMER_0
#define LEDC_MODE           LEDC_HIGH_SPEED_MODE
#define LEDC_DUTY_RES       LEDC_TIMER_13_BIT
#define LEDC_FADE_TIME      1000

// RGB выводы
#define LEDC_GPIO_R         GPIO_NUM_33
#define LEDC_GPIO_G         GPIO_NUM_25
#define LEDC_GPIO_B         GPIO_NUM_26

#define RGB_TO_DUTY(x)  ((x) * (1 << LEDC_DUTY_RES) / 255)

typedef struct {
    ledc_channel_t channel;
    gpio_num_t gpio;
} RGBChannel;

void set_fade(RGBChannel channels[3], uint8_t colors[3]) {
    for (int i = 0; i < 3; i++)
        ledc_set_fade_with_time(LEDC_MODE, channels[i].channel, RGB_TO_DUTY(colors[i]), LEDC_FADE_TIME);
    for (int i = 0; i < 3; i++)
        ledc_fade_start(LEDC_MODE, channels[i].channel, LEDC_FADE_WAIT_DONE);
}

void app_main(void) {
    // Настройка таймера
    ledc_timer_config_t timer_conf = {
        .duty_resolution = LEDC_DUTY_RES,
        .freq_hz = 4000,
        .speed_mode = LEDC_MODE,
        .timer_num = LEDC_TIMER,
        .clk_cfg = LEDC_AUTO_CLK,
    };
    ledc_timer_config(&timer_conf);

    // Настройка каналов
    RGBChannel channels[3] = {
        {LEDC_CHANNEL_0, LEDC_GPIO_R},
        {LEDC_CHANNEL_1, LEDC_GPIO_G},
        {LEDC_CHANNEL_2, LEDC_GPIO_B}
    };

    for (int i = 0; i < 3; i++) {
        ledc_channel_config_t ch = {
            .channel = channels[i].channel,
            .duty = 0,
            .gpio_num = channels[i].gpio,
            .speed_mode = LEDC_MODE,
            .hpoint = 0,
            .timer_sel = LEDC_TIMER,
            .flags.output_invert = 0
        };
        ledc_channel_config(&ch);
    }

    ledc_fade_func_install(0);

    // 7 цветов радуги
    uint8_t rainbow[7][3] = {
        {255,   0,   0}, // Красный
        {255, 127,   0}, // Оранжевый
        {255, 255,   0}, // Желтый
        {0,   255,   0}, // Зеленый
        {0,   255, 255}, // Голубой
        {0,     0, 255}, // Синий
        {255,   0, 255}  // Фиолетовый
    };

    uint8_t state = 0;

    while (1) {
        set_fade(channels, rainbow[state]);
        state = (state + 1) % 7;  // Переход к следующему цвету
    }
}
